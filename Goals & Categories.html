<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Financier – Goals &amp; Categories</title>
  <style>
    /* RESET & BASE STYLES */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: sans-serif;
    }
    html, body {
      width: 100%;
      height: 100%;
      background-color: #0F1114;
      color: #FFFFFF;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    button {
      cursor: pointer;
      border: none;
      outline: none;
      background: none;
    }

    .dollar {
      color: #4e80ee;
    }

    /* LAYOUT */
    .container {
      display: flex;
      height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background-color: #181A1E;
      display: flex;
      flex-direction: column;
      padding: 2rem;
    }
    .sidebar h2 {
      margin-bottom: 1.8rem;
      font-size: 1.8rem;
      color: #FFFFFF;
    }
    .nav-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 0;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-bottom: 0.5rem;
    }
    .nav-item:hover {
      background-color: #24272B;
    }
    .nav-item svg {
      width: 20px;
      height: 20px;
      margin-right: 0.75rem;
      color: #E5E5E5;
    }
    .nav-text {
      font-size: 0.9rem;
    }
    .sidebar-buttons {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .btn-secondary {
      background-color: #2D2F34;
      color: #FFFFFF;
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      border-radius: 6px;
      transition: background 0.2s ease;
      text-align: center;
    }
    .btn-secondary:hover {
      background-color: #3A3D42;
    }
    .btn-blue {
      background-color: #1043B1;
      color: #FFFFFF;
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      border-radius: 6px;
      transition: background 0.2s ease;
      text-align: center;
      border: none;
    }
    .btn-blue:hover {
      background-color: #2D6FE4;
    }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    .content-wrapper {
      width: 100%;
      max-width: 1200px;
    }
    /* PAGE TITLE */
    .page-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* SECTION HEADERS */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .section-header h2 {
      font-size: 1.1rem;
      font-weight: 500;
    }

    /* GOALS SECTION */
    .goals-section {
      margin-bottom: 2rem;
    }
    .goal-card {
      background-color: #181A1E;
      border: 1px solid #2D2F34;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      position: relative;
    }
    .goal-info h4 {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    .goal-info p {
      font-size: 0.85rem;
      color: #A3A3A3;
    }
    .goal-progress {
      margin-top: 0.5rem;
    }
    .goal-info .goal-progress + p {
      margin-top: 0.4rem;
    }
    .progress-bar-bg {
      background-color: #2D2F34;
      border-radius: 4px;
      height: 8px;
      position: relative;
      width: 100%;
      overflow: hidden;
    }
    .progress-bar-fill {
      background-color: #1043B1;
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .goal-actions {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }

    /* TOTAL MONTHLY BUDGET SECTION */
    .budget-section {
      margin-bottom: 2rem;
    }
    .monthly-budget-card {
      background-color: #181A1E;
      border: 1px solid #2D2F34;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .budget-text-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .budget-amount {
      font-size: 1.3rem;
      font-weight: 500;
    }

    /* EXPENSE CATEGORIES SECTION */
    .categories-section {
      margin-bottom: 2rem;
    }
    .category-card {
      background-color: #181A1E;
      border: 1px solid #2D2F34;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .category-info h4 {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    .category-info p {
      font-size: 0.85rem;
      color: #A3A3A3;
    }
    .category-actions {
      display: flex;
      gap: 0.5rem;
    }
    .icon-btn {
      cursor: pointer;
      color: #9CA3AF;
      transition: color 0.2s ease;
      background-color: #2D2F34;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 0;
    }
    .icon-btn:hover {
      color: #FFFFFF;
      background-color: #3A3D42;
    }
    .icon-btn svg {
      width: 18px;
      height: 18px;
      display: inline-block;
      margin: 0;
      vertical-align: middle;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
        justify-content: flex-start;
      }
      .sidebar-buttons {
        margin-top: 1rem;
        flex-direction: row;
      }
      .nav-item {
        margin-right: 1rem;
      }
      .main-content {
        padding: 1.5rem;
      }
    }

    .monthly-budget-card button:hover {
      color: #508de6 !important;
    }
    .category-card button:hover {
      color: #508de6 !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <h2>Financier</h2>
      <div class="nav-item">
        <a href="Goals &amp; Categories.html" style="display: flex; align-items: center;">
          <svg viewBox="0 0 24 24" width="24" height="24" preserveAspectRatio="xMidYMid meet">
            <path d="M9.96094 19.9219C15.459 19.9219 19.9219 15.459 19.9219 9.96094C19.9219 4.46289 15.459 0 9.96094 0C4.46289 0 0 4.46289 0 9.96094C0 15.459 4.46289 19.9219 9.96094 19.9219ZM9.96094 18.2617C5.37109 18.2617 1.66016 14.5508 1.66016 9.96094C1.66016 5.37109 5.37109 1.66016 9.96094 1.66016C14.5508 1.66016 18.2617 5.37109 18.2617 9.96094C18.2617 14.5508 14.5508 18.2617 9.96094 18.2617Z" fill="#508de6"/>
            <path d="M9.96094 16.1523C13.3789 16.1523 16.1523 13.3789 16.1523 9.96094C16.1523 6.54297 13.3789 3.76953 9.96094 3.76953C6.54297 3.76953 3.76953 6.54297 3.76953 9.96094C3.76953 13.3789 6.54297 16.1523 9.96094 16.1523ZM9.96094 14.5801C7.40234 14.5801 5.3418 12.5195 5.3418 9.96094C5.3418 7.40234 7.40234 5.3418 9.96094 5.3418C12.5195 5.3418 14.5801 7.40234 14.5801 9.96094C14.5801 12.5195 12.5195 14.5801 9.96094 14.5801Z" fill="#508de6"/>
            <path d="M9.96094 12.4805C11.3574 12.4805 12.4902 11.3574 12.4902 9.95117C12.4902 8.55469 11.3574 7.42188 9.96094 7.42188C8.56445 7.42188 7.43164 8.55469 7.43164 9.95117C7.43164 11.3574 8.56445 12.4805 9.96094 12.4805Z" fill="#508de6"/>
          </svg>
          <span class="nav-text">Goals &amp; Categories</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="Track Transactions.html" style="display: flex; align-items: center;">
          <svg viewBox="0 0 24 24">
            <path d="M1.29883 18.5156L20.5078 18.5156L20.5078 17.8613C20.5078 17.4707 20.2832 17.2363 19.8828 17.2363L19.2578 17.2363L19.2578 6.69922L20.1172 6.69922C20.6543 6.69922 20.9668 6.30859 20.9668 5.9082C20.9668 5.61523 20.8008 5.36133 20.4395 5.15625L12.0996 0.341797C11.709 0.117188 11.2988 0 10.8984 0C10.498 0 10.0781 0.117188 9.70703 0.341797L1.36719 5.15625C0.996094 5.36133 0.839844 5.61523 0.839844 5.9082C0.839844 6.30859 1.15234 6.69922 1.68945 6.69922L2.54883 6.69922L2.54883 17.2363L1.93359 17.2363C1.5332 17.2363 1.29883 17.4707 1.29883 17.8613ZM4.02344 17.2363L4.02344 5.44922L10.5176 1.80664C10.6348 1.73828 10.7715 1.69922 10.8984 1.69922C11.0254 1.69922 11.1621 1.73828 11.2891 1.80664L17.7832 5.44922L17.7832 17.2363ZM0.78125 20.8398L21.0156 20.8398C21.4453 20.8398 21.8066 20.4785 21.8066 20.0488C21.8066 19.6191 21.4453 19.2676 21.0156 19.2676L0.78125 19.2676C0.351562 19.2676 0 19.6191 0 20.0488C0 20.4785 0.351562 20.8398 0.78125 20.8398Z" fill="#508de6"/>
            <path d="M10.918 14.541C12.5781 14.541 14.043 13.7793 14.043 12.0996C14.043 10.625 12.8613 10.0586 11.5234 9.74609L10.5957 9.53125C9.74609 9.33594 9.02344 8.97461 9.02344 8.17383C9.02344 7.24609 10.0195 6.83594 10.918 6.83594C11.8945 6.83594 12.5586 7.25586 12.8223 8.06641C12.9199 8.36914 13.1055 8.51562 13.3691 8.51562C13.6133 8.51562 13.8965 8.34961 13.8965 8.00781C13.8965 6.75781 12.2949 5.86914 10.918 5.86914C9.3457 5.86914 7.92969 6.74805 7.92969 8.26172C7.92969 9.7168 9.15039 10.2637 10.3516 10.5566L11.2891 10.7715C12.1582 10.9766 12.959 11.2891 12.959 12.1875C12.959 13.252 11.9336 13.584 10.9473 13.584C9.90234 13.584 9.18945 13.252 8.83789 12.3145C8.7207 12.0117 8.55469 11.8945 8.29102 11.8945C8.00781 11.8945 7.77344 12.0801 7.77344 12.4023C7.77344 12.4902 7.79297 12.5977 7.82227 12.7051C8.20312 13.9941 9.63867 14.541 10.918 14.541ZM10.9082 15.7031C11.084 15.7031 11.2305 15.5566 11.2305 15.3809L11.2305 5.05859C11.2305 4.87305 11.084 4.73633 10.9082 4.73633C10.7324 4.73633 10.5859 4.87305 10.5859 5.05859L10.5859 15.3809C10.5859 15.5566 10.7324 15.7031 10.9082 15.7031Z" fill="#508de6"/>
          </svg>
          <span class="nav-text">Track Transactions</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="Analytics.html" style="display: flex; align-items: center;">
          <svg viewBox="0 0 24 24">
            <path d="M0 17.2559C0 17.6953 0.361328 18.0371 0.78125 18.0371L20.9961 18.0371C21.4258 18.0371 21.7871 17.6953 21.7871 17.2559C21.7871 16.8262 21.4258 16.4746 20.9961 16.4746L0.78125 16.4746C0.361328 16.4746 0 16.8262 0 17.2559Z" fill="#508de6"/>
            <path d="M16.7871 13.9941C16.7871 14.541 17.1289 14.8633 17.6953 14.8633L19.9512 14.8633C20.5078 14.8633 20.8594 14.541 20.8594 13.9941L20.8594 7.53906C20.8594 6.99219 20.5078 6.66016 19.9512 6.66016L17.6953 6.66016C17.1289 6.66016 16.7871 6.99219 16.7871 7.53906Z" fill="#508de6"/>
            <path d="M11.4941 13.9941C11.4941 14.541 11.8457 14.8633 12.4023 14.8633L14.6582 14.8633C15.2246 14.8633 15.5762 14.541 15.5762 13.9941L15.5762 3.0957C15.5762 2.54883 15.2246 2.22656 14.6582 2.22656L12.4023 2.22656C11.8457 2.22656 11.4941 2.54883 11.4941 3.0957Z" fill="#508de6"/>
            <path d="M6.21094 13.9941C6.21094 14.541 6.55273 14.8633 7.10938 14.8633L9.375 14.8633C9.93164 14.8633 10.2832 14.541 10.2832 13.9941L10.2832 0.869141C10.2832 0.322266 9.93164 0 9.375 0L7.10938 0C6.55273 0 6.21094 0.322266 6.21094 0.869141Z" fill="#508de6"/>
            <path d="M0.917969 13.9941C0.917969 14.541 1.26953 14.8633 1.82617 14.8633L4.08203 14.8633C4.64844 14.8633 5 14.541 5 13.9941L5 5.35156C5 4.81445 4.64844 4.48242 4.08203 4.48242L1.82617 4.48242C1.26953 4.48242 0.917969 4.81445 0.917969 5.35156Z" fill="#508de6"/>
          </svg>
          <span class="nav-text">Analytics</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="Calculator.html" style="display: flex; align-items: center;">
          <svg viewBox="0 0 24 24">
            <rect x="4" y="2" width="16" height="20" rx="2" fill="#508de6"/>
            <rect x="5" y="3" width="14" height="18" rx="2" fill="#181A1E"/>
            <path d="M9 6h6a1 1 0 0 1 0 2H9a1 1 0 0 1 0-2z" fill="#508de6"/>
            <circle cx="8" cy="10" r="1" fill="#508de6"/>
            <circle cx="12" cy="10" r="1" fill="#508de6"/>
            <circle cx="16" cy="10" r="1" fill="#508de6"/>
            <circle cx="8" cy="14" r="1" fill="#508de6"/>
            <circle cx="12" cy="14" r="1" fill="#508de6"/>
            <rect x="15" y="13" width="2" height="6" rx="1" fill="#508de6"/>
            <circle cx="8" cy="18" r="1" fill="#508de6"/>
            <circle cx="12" cy="18" r="1" fill="#508de6"/>
          </svg>
          <span class="nav-text">Calculator</span>
        </a>
      </div>
      <div class="nav-item">
          <a href="Money Tips.html" style="display: flex; align-items: center;">
            <svg viewBox="0 0 24 24">
              <g transform="translate(6, 0)">
                <path d="M0 6.01562C0 9.76562 2.24609 10.6934 2.87109 17.207C2.91016 17.5586 3.10547 17.7832 3.47656 17.7832L9.58984 17.7832C9.9707 17.7832 10.166 17.5586 10.2051 17.207C10.8301 10.6934 13.0664 9.76562 13.0664 6.01562C13.0664 2.64648 10.1855 0 6.5332 0C2.88086 0 0 2.64648 0 6.01562ZM1.47461 6.01562C1.47461 3.37891 3.78906 1.47461 6.5332 1.47461C9.27734 1.47461 11.5918 3.37891 11.5918 6.01562C11.5918 8.81836 9.73633 9.48242 8.85742 16.3086L4.21875 16.3086C3.33008 9.48242 1.47461 8.81836 1.47461 6.01562ZM3.44727 19.8926L9.62891 19.8926C9.95117 19.8926 10.1953 19.6387 10.1953 19.3164C10.1953 19.0039 9.95117 18.75 9.62891 18.75L3.44727 18.75C3.125 18.75 2.87109 19.0039 2.87109 19.3164C2.87109 19.6387 3.125 19.8926 3.44727 19.8926ZM6.5332 22.7246C8.04688 22.7246 9.30664 21.9824 9.4043 20.8594L3.67188 20.8594C3.74023 21.9824 5.00977 22.7246 6.5332 22.7246Z" fill="#508de6"/>
              </g>
            </svg>
          <span class="nav-text">Money Tips</span>
        </a>
      </div>
      <div class="sidebar-footer" style="color: gray; font-size: 0.8rem; text-align: center; margin-top: auto;">
        <p>Made with ❤️ at the</p>
        <p>University of Pittsburgh</p>
        <br>
        <p>Images courtesy of Undraw</p>
      </div>
    </div>
    <!-- /SIDEBAR -->
    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="content-wrapper">
        <h1 class="page-title">Goals &amp; Categories</h1>

        <!-- FINANCIAL GOALS SECTION -->
        <section class="goals-section">
          <div class="section-header">
            <h2>Financial Goals</h2>
            <button class="btn-blue" id="btnAddGoal">+ Add Goal</button>
          </div>
          <div id="goalsContainer"></div>
        </section>

        <!-- TOTAL MONTHLY BUDGET SECTION -->
        <section class="budget-section">
          <div class="section-header">
            <h2>Total Monthly Budget</h2>
            <button class="btn-blue" id="btnEditBudget">Edit Budget</button>
          </div>
          <div class="monthly-budget-card">
            <div class="budget-text-container">
              <div class="budget-amount" id="monthlyBudgetDisplay">
                <!-- The total monthly budget UI (with arrows) is built dynamically -->
              </div>
            </div>
          </div>
        </section>

        <!-- EXPENSE CATEGORIES SECTION -->
        <section class="categories-section">
          <div class="section-header">
            <h2>Expense Categories</h2>
            <button class="btn-blue" id="btnAddCategory">+ Add Category</button>
          </div>
          <div id="categoriesContainer"></div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // Prompt helper
    function promptNumber(message) {
      let input;
      do {
        input = prompt(message);
        if (input === null) return null;
      } while (isNaN(parseFloat(input)) || input.trim() === "");
      return parseFloat(input);
    }

    // Goals and Categories stored in localStorage
    let storedGoals = localStorage.getItem('goals');
    let goals = storedGoals ? JSON.parse(storedGoals) : [
      { id: 1, title: "Emergency Fund", description: "Save <span class='dollar'>$1000</span> by December 2025", current: 450, target: 1000 }
    ];

    let storedCategories = localStorage.getItem('categories');
    let categories = storedCategories ? JSON.parse(storedCategories) : [
      { id: 1, name: "Entertainment", budget: 100 },
      { id: 2, name: "Academic", budget: 150 },
      { id: 3, name: "Food", budget: 300 }
    ];

    // Total Monthly Budget
    let monthlyBudgets = JSON.parse(localStorage.getItem('monthlyBudgets')) || {};

    // Category-specific monthly budgets (keyed by "YYYY-MM" then category id)
    let storedCategoryBudgets = localStorage.getItem('categoryBudgets');
    let categoryBudgets = storedCategoryBudgets ? JSON.parse(storedCategoryBudgets) : {};

    // Global selectedMonth shared by total budget and category budgets
    let selectedMonth = new Date();
    selectedMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth(), 1);
    
    function getMonthKey(date) {
      return date.getFullYear() + '-' + ("0" + (date.getMonth() + 1)).slice(-2);
    }

    // Total monthly budget getters and renderers
    function getMonthlyBudget() {
      let key = getMonthKey(selectedMonth);
      return monthlyBudgets[key] || 1000;
    }
    function updateMonthlyBudgetDisplay() {
      let key = getMonthKey(selectedMonth);
      let monthYearStr = selectedMonth.toLocaleString('default', { month: 'long', year: 'numeric' });
      document.getElementById('monthlyBudgetDisplay').innerHTML =
        '<button id="prevMonth" style="color: #ffffff; font-size: inherit;">&lt;</button>' +
        '<span id="currentMonthYear"> ' + monthYearStr + ' </span>' +
        '<button id="nextMonth" style="color: #ffffff; font-size: inherit;">&gt;</button>' +
        ' : ' +
        '<span class="dollar">$' + getMonthlyBudget() + '</span>';
      document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
      document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
    }
    function changeMonth(offset) {
      let newMonth = selectedMonth.getMonth() + offset;
      selectedMonth = new Date(selectedMonth.getFullYear(), newMonth, 1);
      let key = getMonthKey(selectedMonth);
      if (monthlyBudgets[key] === undefined) {
        let newBudget = promptNumber("Enter new Total Monthly Budget:");
        monthlyBudgets[key] = newBudget === null ? 1000 : newBudget;
        localStorage.setItem('monthlyBudgets', JSON.stringify(monthlyBudgets));
      }
      updateMonthlyBudgetDisplay();
      // Re-render categories so that each category's month shows the new value
      renderCategories();
      if (typeof updateAnalytics === 'function') {
        updateAnalytics();
      }
    }
    document.getElementById('btnEditBudget').addEventListener('click', () => {
      let key = getMonthKey(selectedMonth);
      let newBudget = promptNumber("Enter new Total Monthly Budget:");
      if (newBudget !== null) {
        monthlyBudgets[key] = newBudget;
        localStorage.setItem('monthlyBudgets', JSON.stringify(monthlyBudgets));
        updateMonthlyBudgetDisplay();
        if (typeof updateAnalytics === 'function') {
          updateAnalytics();
        }
      }
    });
    updateMonthlyBudgetDisplay();

    // Save data for goals, categories, and categoryBudgets
    function saveData() {
      localStorage.setItem('goals', JSON.stringify(goals));
      localStorage.setItem('categories', JSON.stringify(categories));
      localStorage.setItem('categoryBudgets', JSON.stringify(categoryBudgets));
    }

    function updateAnalytics() {
      console.log("Goals:", goals);
      console.log("Categories:", categories);
      console.log("Monthly Budgets:", monthlyBudgets);
      console.log("Category Budgets:", categoryBudgets);
      saveData();
    }

    // Render Goals
    function renderGoals() {
      const container = document.getElementById('goalsContainer');
      container.innerHTML = "";
      goals.forEach(goal => {
        const card = document.createElement('div');
        card.className = 'goal-card';
        const info = document.createElement('div');
        info.className = 'goal-info';
        const h4 = document.createElement('h4');
        h4.innerHTML = goal.title;
        info.appendChild(h4);
        const pDesc = document.createElement('p');
        pDesc.innerHTML = goal.description;
        info.appendChild(pDesc);

        const progressContainer = document.createElement('div');
        progressContainer.className = 'goal-progress';
        const progressBg = document.createElement('div');
        progressBg.className = 'progress-bar-bg';
        const progressFill = document.createElement('div');
        progressFill.className = 'progress-bar-fill';
        let percentage = (goal.current / goal.target) * 100;
        progressFill.style.width = percentage + "%";
        progressBg.appendChild(progressFill);
        progressContainer.appendChild(progressBg);
        info.appendChild(progressContainer);

        const pAmount = document.createElement('p');
        pAmount.innerHTML = "<span class='dollar'>$" + goal.current + "</span> of <span class='dollar'>$" + goal.target + "</span> saved";
        info.appendChild(pAmount);

        card.appendChild(info);

        const actions = document.createElement('div');
        actions.className = 'goal-actions';
        const editBtn = document.createElement('div');
        editBtn.className = 'icon-btn';
        editBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="display: block; margin: auto; position: relative; top: 2px; left: 3px;">
          <path d="M2.66795 14.6297L13.3222 3.98517L11.6133 2.26642L0.949202 12.911L0.021468 15.0887C-0.0761882 15.3231 0.177718 15.5965 0.412093 15.4988ZM14.1816 3.14533L15.168 2.17853C15.666 1.68048 15.6953 1.14338 15.2461 0.694157L14.914 0.362125C14.4746-0.0773278 13.9375-0.0382653 13.4394 0.450016L12.4531 1.42658Z" fill="white" fill-opacity="0.85"/>
        </svg>`;
        editBtn.addEventListener('click', () => editGoal(goal.id));
        actions.appendChild(editBtn);

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'icon-btn';
        deleteBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.5625 18.6035C6.93359 18.6035 7.17773 18.3691 7.16797 18.0273L6.86523 7.57812C6.85547 7.23633 6.61133 7.01172 6.25977 7.01172C5.88867 7.01172 5.64453 7.24609 5.6543 7.58789L5.94727 18.0273C5.95703 18.3789 6.20117 18.6035 6.5625 18.6035ZM9.45312 18.6035C9.82422 18.6035 10.0879 18.3691 10.0879 18.0273L10.0879 7.58789C10.0879 7.24609 9.82422 7.01172 9.45312 7.01172C9.08203 7.01172 8.82812 7.24609 8.82812 7.58789L8.82812 18.0273C8.82812 18.3691 9.08203 18.6035 9.45312 18.6035ZM12.3535 18.6035C12.7051 18.6035 12.9492 18.3789 12.959 18.0273L13.252 7.58789C13.2617 7.24609 13.0176 7.01172 12.6465 7.01172C12.2949 7.01172 12.0508 7.23633 12.041 7.58789L11.748 18.0273C11.7383 18.3691 11.9824 18.6035 12.3535 18.6035ZM5.16602 4.46289L6.71875 4.46289L6.71875 2.37305C6.71875 1.81641 7.10938 1.45508 7.69531 1.45508L11.1914 1.45508C11.7773 1.45508 12.168 1.81641 12.168 2.37305L12.168 4.46289L13.7207 4.46289L13.7207 2.27539C13.7207 0.859375 12.8027 0 11.2988 0L7.58789 0C6.08398 0 5.16602 0.859375 5.16602 2.27539ZM0.732422 5.24414L18.1836 5.24414C18.584 5.24414 18.9062 4.90234 18.9062 4.50195C18.9062 4.10156 18.584 3.76953 18.1836 3.76953L0.732422 3.76953C0.341797 3.76953 0 4.10156 0 4.50195C0 4.91211 0.341797 5.24414 0.732422 5.24414ZM4.98047 21.748L13.9355 21.748C15.332 21.748 16.2695 20.8398 16.3379 19.4434L17.0215 5.05859L15.4492 5.05859L14.7949 19.2773C14.7754 19.8633 14.3555 20.2734 13.7793 20.2734L5.11719 20.2734C4.56055 20.2734 4.14062 19.8535 4.11133 19.2773L3.41797 5.05859L1.88477 5.05859L2.57812 19.4531C2.64648 20.8496 3.56445 21.748 4.98047 21.748Z" fill="white" fill-opacity="0.85"/>
        </svg>`;
        deleteBtn.addEventListener('click', () => deleteGoal(goal.id));
        actions.appendChild(deleteBtn);

        card.appendChild(actions);
        container.appendChild(card);
      });
    }

    // Render Expense Categories with monthly budget and month navigation (using global selectedMonth)
    function renderCategories() {
      const container = document.getElementById('categoriesContainer');
      container.innerHTML = "";
      
      let monthKey = getMonthKey(selectedMonth);
      // Ensure there is an object for this month
      if (!categoryBudgets[monthKey]) {
        categoryBudgets[monthKey] = {};
      }
      
      categories.forEach(cat => {
        // Initialize the category's monthly budget if not already set
        if (categoryBudgets[monthKey][cat.id] === undefined) {
          categoryBudgets[monthKey][cat.id] = cat.budget;
        }
        const budgetThisMonth = categoryBudgets[monthKey][cat.id];
        
        // Create the category card
        const card = document.createElement('div');
        card.className = 'category-card';
        
        const info = document.createElement('div');
        info.className = 'category-info';
        
        // Category title
        const h4 = document.createElement('h4');
        h4.textContent = cat.name;
        info.appendChild(h4);
        
        // Build the month navigation and budget display line
        const pBudget = document.createElement('p');
        pBudget.innerHTML = `
          <button class="prevCatMonth" style="color: #ffffff; font-size: inherit;">&lt;</button>
          <span class="catMonthYear">${selectedMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}</span>
          <button class="nextCatMonth" style="color: #ffffff; font-size: inherit;">&gt;</button>
           : <span class="dollar">$${budgetThisMonth}</span>
        `;
        info.appendChild(pBudget);
        card.appendChild(info);
        
        // Hook up month arrow buttons (they update the global month)
        const prevBtn = pBudget.querySelector('.prevCatMonth');
        const nextBtn = pBudget.querySelector('.nextCatMonth');
        prevBtn.addEventListener('click', () => {
          changeMonth(-1);
          renderCategories();
        });
        nextBtn.addEventListener('click', () => {
          changeMonth(1);
          renderCategories();
        });
        
        // Actions for edit/delete
        const actions = document.createElement('div');
        actions.className = 'category-actions';
        const editBtn = document.createElement('div');
        editBtn.className = 'icon-btn';
        editBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="display: block; margin: auto; position: relative; top: 2px; left: 3px;">
         <path d="M2.66795 14.6297L13.3222 3.98517L11.6133 2.26642L0.949202 12.911L0.021468 15.0887C-0.0761882 15.3231 0.177718 15.5965 0.412093 15.4988ZM14.1816 3.14533L15.168 2.17853C15.666 1.68048 15.6953 1.14338 15.2461 0.694157L14.914 0.362125C14.4746-0.0773278 13.9375-0.0382653 13.4394 0.450016L12.4531 1.42658Z" fill="white" fill-opacity="0.85"/>
        </svg>`;
        editBtn.addEventListener('click', () => editCategory(cat.id));
        actions.appendChild(editBtn);

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'icon-btn';
        deleteBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.5625 18.6035C6.93359 18.6035 7.17773 18.3691 7.16797 18.0273L6.86523 7.57812C6.85547 7.23633 6.61133 7.01172 6.25977 7.01172C5.88867 7.01172 5.64453 7.24609 5.6543 7.58789L5.94727 18.0273C5.95703 18.3789 6.20117 18.6035 6.5625 18.6035ZM9.45312 18.6035C9.82422 18.6035 10.0879 18.3691 10.0879 18.0273L10.0879 7.58789C10.0879 7.24609 9.82422 7.01172 9.45312 7.01172C9.08203 7.01172 8.82812 7.24609 8.82812 7.58789L8.82812 18.0273C8.82812 18.3691 9.08203 18.6035 9.45312 18.6035ZM12.3535 18.6035C12.7051 18.6035 12.9492 18.3789 12.959 18.0273L13.252 7.58789C13.2617 7.24609 13.0176 7.01172 12.6465 7.01172C12.2949 7.01172 12.0508 7.23633 12.041 7.58789L11.748 18.0273C11.7383 18.3691 11.9824 18.6035 12.3535 18.6035ZM5.16602 4.46289L6.71875 4.46289L6.71875 2.37305C6.71875 1.81641 7.10938 1.45508 7.69531 1.45508L11.1914 1.45508C11.7773 1.45508 12.168 1.81641 12.168 2.37305L12.168 4.46289L13.7207 4.46289L13.7207 2.27539C13.7207 0.859375 12.8027 0 11.2988 0L7.58789 0C6.08398 0 5.16602 0.859375 5.16602 2.27539ZM0.732422 5.24414L18.1836 5.24414C18.584 5.24414 18.9062 4.90234 18.9062 4.50195C18.9062 4.10156 18.584 3.76953 18.1836 3.76953L0.732422 3.76953C0.341797 3.76953 0 4.10156 0 4.50195C0 4.91211 0.341797 5.24414 0.732422 5.24414ZM4.98047 21.748L13.9355 21.748C15.332 21.748 16.2695 20.8398 16.3379 19.4434L17.0215 5.05859L15.4492 5.05859L14.7949 19.2773C14.7754 19.8633 14.3555 20.2734 13.7793 20.2734L5.11719 20.2734C4.56055 20.2734 4.14062 19.8535 4.11133 19.2773L3.41797 5.05859L1.88477 5.05859L2.57812 19.4531C2.64648 20.8496 3.56445 21.748 4.98047 21.748Z" fill="white" fill-opacity="0.85"/>
        </svg>`;
        deleteBtn.addEventListener('click', () => deleteCategory(cat.id));
        actions.appendChild(deleteBtn);

        card.appendChild(actions);
        container.appendChild(card);
      });
      // Save updated categoryBudgets to localStorage
      localStorage.setItem('categoryBudgets', JSON.stringify(categoryBudgets));
    }

    // Goal editing and deletion functions
    function editGoal(id) {
      let goal = goals.find(g => g.id === id);
      if (goal) {
        const plainTitle = goal.title.replace(/<span class='dollar'>(\$[0-9]+(\.[0-9]+)?)<\/span>/g, '$1');
        let newTitle = prompt("Edit goal title:", plainTitle);
        if (newTitle === null) return;
        newTitle = newTitle.trim();
        if (newTitle === "") newTitle = plainTitle;
        const processedTitle = newTitle.replace(/(\$\d+(\.\d+)?)/g, "<span class='dollar'>$1</span>");

        const plainDesc = goal.description.replace(/<span class='dollar'>(\$[0-9]+(\.[0-9]+)?)<\/span>/g, '$1');
        let newDesc = prompt("Edit goal description:", plainDesc);
        if (newDesc === null) return;
        const processedDesc = (newDesc || "").replace(/(\$\d+(\.\d+)?)/g, "<span class='dollar'>$1</span>");

        let newCurrent = promptNumber("Edit current saved amount (current: " + goal.current + "):");
        if (newCurrent === null) return;

        let newTarget = promptNumber("Edit goal target amount (current: " + goal.target + "):");
        if (newTarget === null) return;
        if (newTarget <= 0) {
          alert("Target must be greater than 0.");
          return;
        }

        goal.title = processedTitle;
        goal.description = processedDesc;
        goal.current = newCurrent;
        goal.target = newTarget;
        renderGoals();
        updateAnalytics();
      }
    }

    function deleteGoal(id) {
      if (confirm("Are you sure you want to delete this goal?")) {
        goals = goals.filter(g => g.id !== id);
        renderGoals();
        updateAnalytics();
      }
    }

    // Category editing and deletion functions
    function editCategory(id) {
      let cat = categories.find(c => c.id === id);
      if (cat) {
        let newName = prompt("Edit category name:", cat.name);
        if (newName === null) return;
        newName = newName.trim();
        if (newName === "") newName = cat.name;
        
        let monthKey = getMonthKey(selectedMonth);
        // Ensure an object for this month exists
        if (!categoryBudgets[monthKey]) {
          categoryBudgets[monthKey] = {};
        }
        
        let currentBudget = categoryBudgets[monthKey][cat.id] !== undefined ? categoryBudgets[monthKey][cat.id] : cat.budget;
        let newBudget = promptNumber("Edit monthly budget for " + cat.name + " (current: " + currentBudget + "):");
        if (newBudget === null) return;

        // Update the budget in the categoryBudgets for the current month
        categoryBudgets[monthKey][cat.id] = newBudget;
        localStorage.setItem('categoryBudgets', JSON.stringify(categoryBudgets));
        renderCategories();
        updateAnalytics();
      }
    }

    function deleteCategory(id) {
      if (confirm("Are you sure you want to delete this category?")) {
        categories = categories.filter(c => c.id !== id);
        renderCategories();
        updateAnalytics();
      }
    }

    function generateId() {
      return Date.now();
    }

    // New Category Add: also initialize its monthly budget for the current month
    document.getElementById('btnAddCategory').addEventListener('click', () => {
      const name = prompt("Enter category name:");
      if (!name) return;
      const budget = promptNumber("Enter monthly budget for this category:");
      if (budget === null) return;
      
      const newCat = { id: generateId(), name: name.trim(), budget: budget };
      categories.push(newCat);
      
      let monthKey = getMonthKey(selectedMonth);
      if (!categoryBudgets[monthKey]) {
        categoryBudgets[monthKey] = {};
      }
      categoryBudgets[monthKey][newCat.id] = budget;
      localStorage.setItem('categoryBudgets', JSON.stringify(categoryBudgets));
      
      renderCategories();
      updateAnalytics();
    });

    // New Goal Add
    document.getElementById('btnAddGoal').addEventListener('click', () => {
      const title = prompt("Enter goal title:");
      if (!title) return;
      const description = prompt("Enter goal description:");
      const current = promptNumber("Enter current saved amount:");
      const target = promptNumber("Enter goal target amount:");
      if (target <= 0) {
        alert("Target must be greater than 0.");
        return;
      }
      const processedTitle = title.trim().replace(/(\$\d+(\.\d+)?)/g, "<span class='dollar'>$1</span>");
      const processedDescription = (description || "").replace(/(\$\d+(\.\d+)?)/g, "<span class='dollar'>$1</span>");
      const newGoal = {
        id: generateId(),
        title: processedTitle,
        description: processedDescription,
        current: current,
        target: target
      };
      goals.push(newGoal);
      renderGoals();
      updateAnalytics();
    });

    // Initial rendering
    renderGoals();
    renderCategories();
    updateAnalytics();
  </script>
</body>
</html>